### `MQTT`简介

`MQTT`给予二进制消息的发布/订阅编程模式的消息协议



`MQTT`遵循以下设计原则：

1. 精简，不添加可有可无的功能。
2. 发布/订阅（Pub/Sub）模式，方便消息在传感器之间传递。
3. 允许用户动态创建主题，零运维成本。
4. 把传输量降到最低以提高传输效率。
5. 把低带宽、高延迟、不稳定的网络等因素考虑在内。
6. 支持连续的会话控制。
7. 理解客户端计算能力可能很低。
8. 提供服务质量管理。
9. 假设数据不可知，不强求传输数据的类型与格式，保持灵活性。



### 发布/订阅模式

发布/订阅模式解耦了发布消息的客户（发布者）与订阅消息的客户（订阅者）之间的关系，意味着发布者与订阅者之间并不需要之间建立联系。

好处：

- 发布者与订阅者不比了解彼此，只要认识同一个消息代理即可。
- 发布者和订阅者不需要交互，发布者无需等待订阅者确认而导致锁定。
- 发布者和订阅者不需要同时在线，可以自由选择时间来消费消息。



### 主题

`MQTT`通过主题对消息进行分类，本质上就是一个`UTF-8`的字符串，不过可以通过反斜杠表示多喝层级关系。主题不需要创建，直接使用。

主题还可以通过通配符进行过滤。其中，`+`可以过滤一个层级，`*`只能出现在主题最后表示过滤任意级别的层级。例：

```
building-b/floor-5：B楼5层的设备
+/floor-5：任一楼的5层
building-b/*：B楼所有的设备
```

==`MQTT`允许使用通配符订阅主题，但不允许使用通配符广播==



### 服务质量

`MQTT`提供三种不同级别的服务质量（`Quality of Service，QoS`）为不同场景提供消息可靠性：

- 级别0：尽力而为。消息发送者会想尽办法发送消息，但是遇到意外并==不会重试==
- 级别1：至少一次。消息接收者如果没有知会或者知会本身丢失，消息发送者会再次发送以保证消息接收者==至少会收到一次==，当然可能造成重复消息
- 级别2：恰好一次。保证这种语义肯定会减少并发或者增加延时，不过丢失或者重复消息是不可接受的时候，级别2是最合适的



### 消息类型

`MQTT`拥有14种不同的消息类型：

1. `CONNECT`：客户端连接到`MQTT`代理
2. `CONNACK`：连接确认
3. `PUBLISH`：新发布消息
4. `PUBACK`：新发布消息确认，是`QoS 1`给`PUBLISH`消息的回复
5. `PUBREC`：`QoS 2`消息流的第一部分，表示消息发布已记录
6. `PUBREL`：`QoS 2`消息流的第二部分，表示消息发布已释放
7. `PUBCOMP`：`QoS 2`消息流的第三部分，表示消息发布完成
8. `SUBSCRIBE`：客户端订阅某个主题
9. `SUBACK`：对于`SUBSCRIBE`消息的确认
10. `UNSUBSCRIBE`：客户端终止订阅的消息
11. `UNSUBACK`：对于`UNSUBSCRIBE`消息的确认
12. `PINGREQ`：心跳
13. `PINGRESP`：确认心跳
14. `DISCONNECT`：客户端终止连接前优雅地通知MQTT代理