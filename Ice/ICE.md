[ICE简单介绍及使用示例](https://blog.csdn.net/abcdefg367/article/details/84714272)

### 1、ICE工作方式

> Ice是一种面向对象的中间件平台，Ice为构建面向对象的`客户-服务器`应用提供了工具、`API`和库的支持
>
> 与Ice持有的对象进行通信，客户端必须持有这个对象的代理，此处代理指的是这个对象的实例，Ice会在运行时定位到这个对象，然后寻找或激活它，再把In参数传给远程对象，再通过Out参数获取返回结果



- **Ice对象**

  Ice对象是一种概念性实体（或称抽象），具有一下特点：

  - Ice对象是本地或远地的地址空间中、能响应客户请求的实体；
  - 一个Ice对象可在单个或多个服务器中实例化（后者为冗余方式）。如果某个对象同时有多个实例，它仍是一个Ice对象；
  - 每个Ice对象都有一个或多个接口。一个接口是一个对象所支持的一系列的有名称的操作。客户可以通过调用操作来发出请求；
  - 一个操作有零个或更多参数，以及一个返回值。参数和返回值具有明确的类型。参数是有名称的，且有方向：in参数由客户端初始化，并传给服务器；out参数由服务器初始化，并传给客户端（返回值只是一种特殊的out参数）；
  - 一个Ice对象有有一个特殊的接口，称它为主接口。此外，Ice对象还提供零个或多个其他接口，称为`facets`（面）；
  - 每个Ice对象都有一个唯一标识的对象标识。对象标识是用于把一个对象与其他所有对象区别开来的标识值。Ice对象模型假定对象标识是全局唯一的，即在一个Ice通信域中，不会有两个对象具有相同的对象标识；




- **Ice代理**

	> 代理是根据`SLICE`定义的`ice`文件实现，它提供了一个向下调用的接口，提供了数据的序列化与反序化

	- 直接代理

		直接代理其内部保存有某个对象的标识，以及它的服务器的运行地址；

	- 间接代理

		间接代理指的是其内部保存有某个对象的标识，以及对象适配器（`object adapter name`）；

		间接代理没有包含寻址地址，为了正确定位服务器，客户端在运行时会使用内部的对象适配器名，将其传给某个定位服务器，然后定位器会把适配器名当作关键字，在含有服务器地址的表中进行查找，把当前的服务器地址返回给客户端；



> Ice可以保证在任何的网络环境或者操作系统下，成功的调用一次，它在运行时会尽力的定位到远程服务器，在连接失败的情况下会做重复性连接，确实连接不上的情况会给用户以提示

客户端在调用服务端的方法时，可以采取同步或异步的方法实现

- 同步调用就相当于调用自己本地的方法一样，其他行为会被阻塞
- 异步调用，如服务端需要的数据来自于其他异步接口，这个时候客户端不需要等待，待服务端数据准备充分后，会以消息的方式通知客户端，服务端就能干其他事情，而客户端也可以到服务端获取数据

### 2、ICE调用模式

ICE采用的网络协议有`TCP`、`UDP`以及`SSL`三种

ICE在调用模式上有好几种选择方案，并且每种方案正对不同的网络协议的特性做了相应的选择：

- `Oneway`（单向调用）

	客户端只需将调用注册到本地传输缓冲区（`Local Transport Buffers`）后就立即返回，不会等待调用结果的返回，不对调用结果负责

- `Twoway`（双向调用）

	最通用的模式，同步方法调用模式，只能用`TCP`或`SSL`协议

- `Datagram`（数据报）

	类似于`Oneway`调用，不同的是`Datagram`调用只能采取`UDP`协议，而且只能调用无返回值的无输出参数的方法

- `BatchOneway`（批量单向调用）

	先将调用存在调用缓冲区中，到达一定限额后自动批量发送所有请求（也可手动刷除缓冲区）

- `BatchDatagram`（批量数据报）

	与上类似，类似于`BatchOneway`，只能采取`UDP`协议

> 不同的调用模式其实对应不同的业务
>
> - 对于大部分的有返回值的或需要实时响应的方法，我们可能都采用`Twoway`方式调用；
> - 对于一些无需返回值或不依赖返回值的业务，我们可以用`Oneway`或`BatchOneWay`方式，如消息通知；
> - `Datagram`与`BatchDatagram`方式一般用在无返回值且不做可靠性检查的业务上，如日志；







初始化ice

```
Ice::InitializationData initData;
initData.properties = ICE::createProperties();
initData.properties->setProperty("Ice.MessageSizeMax", "102400");
Ice::Communicator pCommunicator = Ice::initialize(initData);
```

- 直连方式获取服务代理

```
/* 传入远程服务单元的名称、网络协议、IP及端口，获取远程代理，使用stringToProxy方式   */
Ice::ObjectPrx base = pCommnicator->stringToProxy("");
/* 通过checkedCast向下转换，获取service接口的远程，并同时检测根据传入的名称获取的服务单元是否Printer的代理接口 */
ServicePrx servicePrx = ProxyHandle::checkedCast(base);
```

- `iceGrid`方式获取代理

使用`iceGrid`的方式获取服务代理时需要按客户端ice初始化时添加属性
